<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>KCS Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    .chat-wrapper {
      max-width: 420px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      height: 80vh;
    }
    .header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    .bubble {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 85%;
      font-size: 14px;
    }
    .bot {
      background: #eef2f6;
    }
    .user {
      background: #0f4c75;
      color: #fff;
      margin-left: auto;
    }
    .thinking {
      font-style: italic;
      opacity: 0.6;
    }
    .input {
      display: flex;
      padding: 12px;
      border-top: 1px solid #e5e7eb;
    }
    input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    button {
      margin-left: 8px;
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: #0f4c75;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="chat-wrapper">
  <div class="header">
    <strong>KCS Assistant</strong>
    <span>ðŸŸ¢ 24/7 online</span>
  </div>

  <div class="messages" id="messages">
    <div class="bubble bot">
      Hallo und willkommen bei KCS ðŸ‘‹  
      MÃ¶chten Sie einen Termin vereinbaren oder haben Sie eine kurze Frage?
    </div>
  </div>

  <div class="input">
    <input id="input" placeholder="Ihre Nachrichtâ€¦" />
    <button onclick="send()">Senden</button>
  </div>
</div>

<script>
let pendingBooking = null;

function addMessage(text, type) {
  const div = document.createElement("div");
  div.className = `bubble ${type}`;
  div.textContent = text;
  document.getElementById("messages").appendChild(div);
  div.scrollIntoView({ behavior: "smooth" });
}

function showThinking() {
  addMessage("â€¦", "bot thinking");
}

function clearThinking() {
  const bubbles = document.querySelectorAll(".thinking");
  bubbles.forEach(b => b.remove());
}

function normalizeToSlot(date) {
  const minutes = date.getMinutes();
  const slot = Math.ceil(minutes / 45) * 45;
  date.setMinutes(slot === 60 ? 0 : slot);
  if (slot === 60) date.setHours(date.getHours() + 1);
  date.setSeconds(0);
  date.setMilliseconds(0);
  return date;
}

async function send() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  addMessage(text, "user");
  showThinking();

  setTimeout(async () => {
    clearThinking();

    // JA/NEIN-BestÃ¤tigung
    if (pendingBooking && pendingBooking.awaitingConfirmation) {
      if (text.toLowerCase().startsWith("ja")) {
        await fetch("/api/calendar-book", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            start: pendingBooking.start.toISOString(),
            end: new Date(pendingBooking.start.getTime() + 45 * 60000).toISOString(),
            summary: "KCS Beratungstermin",
            description: "Erstellt durch KCS Assistant"
          })
        });
        addMessage("Perfekt â€“ der Termin ist eingetragen âœ…", "bot");
        pendingBooking = null;
        return;
      } else {
        pendingBooking = null;
        addMessage("Alles klar. Nennen Sie mir gern einen anderen Zeitpunkt.", "bot");
        return;
      }
    }

    // ZEIT ERKENNEN (vereinfachtes Beispiel)
    if (text.match(/\d{1,2}:\d{2}/)) {
      const now = new Date();
      const time = text.match(/(\d{1,2}):(\d{2})/);
      const date = new Date(now);
      date.setHours(+time[1], +time[2], 0, 0);

      const slotDate = normalizeToSlot(new Date(date));

      if (slotDate.getTime() !== date.getTime()) {
        pendingBooking = { start: slotDate, awaitingConfirmation: true };
        addMessage(
          `Leider ist ${time[0]} nicht verfÃ¼gbar. WÃ¼rde ${slotDate.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})} passen?`,
          "bot"
        );
        return;
      }

      pendingBooking = { start: slotDate, awaitingConfirmation: true };
      addMessage(
        `Soll ich den Termin um ${slotDate.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})} fÃ¼r 45 Minuten eintragen? (Ja/Nein)`,
        "bot"
      );
      return;
    }

    addMessage("Gerne. Wobei kann ich Ihnen helfen?", "bot");
  }, 600);
}
</script>

</body>
</html>
